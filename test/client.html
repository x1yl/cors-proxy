<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>CORS Proxy Endpoint Tester</title>
		<link rel="stylesheet" href="styles.css" />
	</head>
	<body>
		<h1>CORS Proxy Endpoint Tester</h1>

		<div class="container">
			<div class="controls">
				<label for="proxyUrl">Proxy URL:</label>
				<input type="text" id="proxyUrl" value="http://localhost:8787" placeholder="http://localhost:8787" />
				<button id="runAllTests">Run All Tests</button>
			</div>

			<div class="tabs">
				<div class="tab active" id="automatedTestsTab">Automated Tests</div>
				<div class="tab" id="individualEndpointTab">Individual Endpoint Test</div>
				<div class="tab" id="webSocketTab">WebSocket Test</div>
			</div>

			<div id="automatedTestsSection">
				<div class="category-buttons">
					<h3>Test Specific Categories:</h3>
					<button class="category" data-test-category="BasicEndpoints">Basic Endpoints</button>
					<button class="category" data-test-category="StatusCodes">Status Codes</button>
					<button class="category" data-test-category="ResponseHeaders">Response Headers</button>
					<button class="category" data-test-category="SpecialFormats">Special Formats</button>
					<button class="category" data-test-category="EncodingAndCompression">Encoding & Compression</button>
					<button class="category" data-test-category="Authentication">Authentication</button>
					<button class="category" data-test-category="Streaming">Streaming</button>
					<button class="category" data-test-category="RedirectsAndCookies">Redirects & Cookies</button>
					<button class="category" data-test-category="Images">Images</button>
					<button class="category" data-test-category="DelayAndTimeout">Delay & Timeout</button>
					<button class="category" data-test-category="Trailers">HTTP Trailers</button>
					<button class="category" data-test-category="MiscEndpoints">Miscellaneous</button>
					<button class="category" data-test-category="SSE">Server-Sent Events</button>
					<button class="category" data-test-category="WebSockets">WebSockets</button>
				</div>
			</div>

			<div id="individualEndpointSection" style="display: none">
				<div class="section-title">
					<h3>Test Individual Endpoint</h3>
					<p>Enter an endpoint path and optional parameters to test</p>
				</div>

				<div class="form-group">
					<label for="endpointInput">Endpoint Path:</label>
					<input type="text" id="endpointInput" placeholder="/get" value="/get" />
				</div>

				<div class="form-group">
					<label for="methodSelect">HTTP Method:</label>
					<select id="methodSelect">
						<option value="GET">GET</option>
						<option value="POST">POST</option>
						<option value="PUT">PUT</option>
						<option value="DELETE">DELETE</option>
						<option value="PATCH">PATCH</option>
						<option value="HEAD">HEAD</option>
						<option value="OPTIONS">OPTIONS</option>
					</select>
				</div>

				<div class="form-group" id="bodySection" style="display: none">
					<label for="requestBodyInput">Request Body (JSON):</label>
					<textarea id="requestBodyInput" placeholder='{"key": "value"}'></textarea>
				</div>

				<div class="form-group">
					<label for="headersInput">Headers (JSON):</label>
					<textarea id="headersInput" placeholder='{"Content-Type": "application/json"}'></textarea>
				</div>

				<button id="testEndpointBtn">Test Endpoint</button>

				<div class="section-title">
					<h3>Quick Tests</h3>
				</div>

				<div class="quick-tests">
					<button class="quick-test" data-endpoint="/get">GET Request</button>
					<button class="quick-test" data-endpoint="/post" data-method="POST">POST Request</button>
					<button class="quick-test" data-endpoint="/status/404">404 Status</button>
					<button class="quick-test" data-endpoint="/uuid">Get UUID</button>
					<button class="quick-test" data-endpoint="/image/png">PNG Image</button>
					<button class="quick-test" data-endpoint="/ip">Get IP</button>
					<button class="quick-test" data-endpoint="/headers">Headers</button>
					<button class="quick-test" data-endpoint="/gzip">GZIP</button>
					<button class="quick-test" data-endpoint="/user-agent">User-Agent</button>
					<button class="quick-test" data-endpoint="/delay/1">Delay (1s)</button>
					<button class="quick-test" data-endpoint="/stream/5">Stream Lines</button>
					<button class="quick-test" data-endpoint="/base64/encode/test">Base64 Encode</button>
					<button class="quick-test" data-endpoint="/cookies">Cookies</button>
					<button class="quick-test" data-endpoint="/anything/test123">Anything</button>
					<button class="quick-test" data-endpoint="/xml">XML</button>
				</div>
			</div>

			<div id="webSocketSection" style="display: none">
				<div class="section-title">
					<h3>WebSocket Test</h3>
					<p>Test WebSocket connections through the proxy</p>
				</div>

				<div class="form-group">
					<label for="wsTargetUrl">WebSocket Target URL:</label>
					<input type="text" id="wsTargetUrl" value="wss://echo.websocket.org/" placeholder="wss://echo.websocket.org/" />
				</div>

				<div class="ws-controls">
					<button id="wsConnectBtn">Connect</button>
					<button id="wsDisconnectBtn" disabled>Disconnect</button>
				</div>

				<div class="ws-test-buttons">
					<button id="wsEchoTest" disabled>Run Echo Test (5 Messages)</button>
					<button id="wsClearOutput">Clear Output</button>
				</div>

				<div id="wsOutput" class="output-box"></div>

				<div class="form-group">
					<label for="wsMessage">Message:</label>
					<input type="text" id="wsMessage" placeholder="Type a message to send" disabled />
					<button id="wsSendBtn" disabled>Send</button>
				</div>
			</div>

			<div id="testOutput" class="output"></div>
		</div>

		<script src="client.js"></script>
		<script>
			document.addEventListener('DOMContentLoaded', () => {
				// Tab elements
				const tabs = {
					automated: document.getElementById('automatedTestsTab'),
					individual: document.getElementById('individualEndpointTab'),
					websocket: document.getElementById('webSocketTab'),
				};

				const sections = {
					automated: document.getElementById('automatedTestsSection'),
					individual: document.getElementById('individualEndpointSection'),
					websocket: document.getElementById('webSocketSection'),
				};

				// WebSocket elements
				const ws = {
					targetUrl: document.getElementById('wsTargetUrl'),
					connectBtn: document.getElementById('wsConnectBtn'),
					disconnectBtn: document.getElementById('wsDisconnectBtn'),
					message: document.getElementById('wsMessage'),
					sendBtn: document.getElementById('wsSendBtn'),
					output: document.getElementById('wsOutput'),
					echoTest: document.getElementById('wsEchoTest'),
					clearOutput: document.getElementById('wsClearOutput'),
				};

				let socket = null;

				// Tab switching logic
				function switchTab(tabName) {
					// Deactivate all tabs
					Object.values(tabs).forEach((tab) => tab.classList.remove('active'));
					Object.values(sections).forEach((section) => (section.style.display = 'none'));

					// Activate selected tab
					tabs[tabName].classList.add('active');
					sections[tabName].style.display = 'block';

					// Show/hide test output
					document.getElementById('testOutput').style.display = tabName === 'websocket' ? 'none' : 'block';
				}

				tabs.automated.addEventListener('click', () => switchTab('automated'));
				tabs.individual.addEventListener('click', () => switchTab('individual'));
				tabs.websocket.addEventListener('click', () => switchTab('websocket'));

				// WebSocket functionality
				function logWsMessage(text, type = 'system') {
					const div = document.createElement('div');
					div.className = `ws-${type}`;
					div.textContent = text;
					ws.output.appendChild(div);
					ws.output.scrollTop = ws.output.scrollHeight;
				}

				// Connect to WebSocket
				ws.connectBtn.addEventListener('click', () => {
					const proxyUrl = document.getElementById('proxyUrl').value.trim();
					const targetUrl = ws.targetUrl.value.trim();

					if (!proxyUrl || !targetUrl) {
						logWsMessage('Please enter both proxy URL and WebSocket target URL', 'error');
						return;
					}

					try {
						// Convert HTTP proxy URL to WebSocket URL
						let wsProxyUrl = proxyUrl;
						if (wsProxyUrl.startsWith('http://')) {
							wsProxyUrl = wsProxyUrl.replace('http://', 'ws://');
						} else if (wsProxyUrl.startsWith('https://')) {
							wsProxyUrl = wsProxyUrl.replace('https://', 'wss://');
						}

						const fullUrl = `${wsProxyUrl}/?${encodeURIComponent(targetUrl)}`;
						logWsMessage(`Connecting to: ${fullUrl}`);

						socket = new WebSocket(fullUrl);

						socket.onopen = () => {
							logWsMessage('Connection established');
							ws.message.disabled = false;
							ws.sendBtn.disabled = false;
							ws.connectBtn.disabled = true;
							ws.disconnectBtn.disabled = false;
							ws.echoTest.disabled = false;
						};

						socket.onmessage = (event) => {
							try {
								const data = JSON.parse(event.data);
								if (data.type && data.message) {
									logWsMessage(`[${data.type}] ${data.message}`, data.type);
								} else {
									logWsMessage(`Received: ${event.data}`, 'receive');
								}
							} catch {
								logWsMessage(`Received: ${event.data}`, 'receive');
							}
						};

						socket.onclose = (event) => {
							logWsMessage(`Connection closed (Code: ${event.code})${event.reason ? ' - ' + event.reason : ''}`);
							disconnectWs();
						};

						socket.onerror = (error) => {
							logWsMessage(`Error: ${error.message || 'Connection error'}`, 'error');
						};
					} catch (error) {
						logWsMessage(`Failed to create WebSocket: ${error.message}`, 'error');
					}
				});

				function disconnectWs() {
					if (socket) {
						socket.close();
						socket = null;
					}

					ws.message.disabled = true;
					ws.sendBtn.disabled = true;
					ws.connectBtn.disabled = false;
					ws.disconnectBtn.disabled = true;
					ws.echoTest.disabled = true;
				}

				ws.disconnectBtn.addEventListener('click', () => {
					disconnectWs();
					logWsMessage('Disconnected by user');
				});

				function sendWsMessage() {
					const message = ws.message.value.trim();
					if (!message || !socket || socket.readyState !== WebSocket.OPEN) return;

					socket.send(message);
					logWsMessage(`Sent: ${message}`, 'send');
					ws.message.value = '';
				}

				ws.sendBtn.addEventListener('click', sendWsMessage);

				ws.message.addEventListener('keypress', (e) => {
					if (e.key === 'Enter') {
						sendWsMessage();
					}
				});

				// Echo test functionality
				ws.echoTest.addEventListener('click', async () => {
					if (!socket || socket.readyState !== WebSocket.OPEN) {
						logWsMessage('WebSocket is not connected', 'error');
						return;
					}

					logWsMessage('Starting echo test with 5 messages...', 'system');

					const sent = [];
					const received = [];
					const originalOnMessage = socket.onmessage;

					socket.onmessage = (event) => {
						try {
							const data = JSON.parse(event.data);
							if (data.type === 'system' || data.type === 'open') {
								logWsMessage(`System message: ${data.message}`, 'system');
								return;
							}
						} catch {
							received.push(event.data);
							logWsMessage(`Echo test received: ${event.data}`, 'receive');

							if (received.length === 5) {
								const allEchoed = sent.every((msg) => received.includes(msg));

								if (allEchoed) {
									logWsMessage('✅ Echo test passed! All 5 messages were echoed back correctly.', 'system');
								} else {
									logWsMessage('❌ Echo test failed. Not all messages were echoed back correctly.', 'error');

									const missing = sent.filter((msg) => !received.includes(msg));
									if (missing.length > 0) {
										logWsMessage(`Messages not echoed: ${missing.join(', ')}`, 'error');
									}
								}

								socket.onmessage = originalOnMessage;
							}
						}
					};

					logWsMessage('Waiting 1 second before sending test messages...', 'system');
					await new Promise((resolve) => setTimeout(resolve, 1000));

					for (let i = 1; i <= 5; i++) {
						const message = `Test message ${i} - ${new Date().toISOString()}`;
						sent.push(message);
						socket.send(message);
						logWsMessage(`Echo test sent: ${message}`, 'send');
						await new Promise((resolve) => setTimeout(resolve, 500));
					}
				});

				ws.clearOutput.addEventListener('click', () => {
					ws.output.innerHTML = '';
					logWsMessage('Output cleared', 'system');
				});

				// Method select change handler to show/hide body input
				const methodSelect = document.getElementById('methodSelect');
				if (methodSelect) {
					methodSelect.addEventListener('change', () => {
						const bodySection = document.getElementById('bodySection');
						if (bodySection) {
							bodySection.style.display = ['POST', 'PUT', 'PATCH'].includes(methodSelect.value) ? 'block' : 'none';
						}
					});
				}
			});
		</script>
	</body>
</html>
